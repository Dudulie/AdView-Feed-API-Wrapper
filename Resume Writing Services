<?php
function getLocations()
{
    return array(
        'Basingstoke', 'Exeter', 'Nottingham', 'Birmingham', 'Gloucester', 'Oxford', 'Bradford', 'Guildford', 'Oxfordshire',
        'Brighton', 'Hampshire', 'Peterborough', 'Bristol', 'Hertfordshire', 'Preston', 'Buckinghamshire', 'Kent', 'Reading',
        'Cambridge', 'Leeds', 'Sheffield', 'Cambridgeshire', 'Leicester', 'Slough', 'Chelmsford', 'Leicestershire',
        'Southampton', 'Cheshire', 'Liverpool', 'Stockport', 'Chester', 'London', 'Surrey', 'Coventry', 'Maidstone', 'Swindon',
        'Croydon', 'Manchester', 'Wakefield', 'Derby', 'Milton Keynes', 'Warrington', 'Derbyshire', 'Newcastle upon Tyne',
        'West Yorkshire', 'Doncaster', 'Northampton', 'York',
    );
}

function getCategories()
{
    return array(
        'Accounting', 'Finance', 'Pharmaceutical', 'Administrative', 'Food Service', 'PR', 'Advertising', 'Healthcare',
        'Publishing', 'Agriculture', 'Hospitality', 'Real Estate', 'Architecture', 'Human Resources', 'Restaurant', 'Arts',
        'Insurance', 'Retail', 'Banking', 'IT', 'Sales', 'Computer', 'Law Enforcement', 'Scientific', 'Construction', 'Legal',
        'Security', 'Consulting', 'Loans', 'Social Care', 'Customer Service', 'Logistics', 'Telecommunications', 'Education',
        'Management', 'Training', 'Energy', 'Manufacturing', 'Transportation', 'Engineering', 'Marketing', 'Travel', 'Facilities',
        'Mechanical', 'Volunteering',
    );
}

function getPaginationIndex($current_page, $last_page, $index_count)
{
    $low_index = $current_page - round($index_count / 2) + 1;
    $high_index = max($low_index, 1) + $index_count - 1;
    if ($high_index > $last_page)
    {
        $high_index = $last_page;
        $low_index = $high_index - $index_count + 1;
    }
    $low_index = max($low_index, 1);
    return array($low_index, $high_index);
}

function generateURL($data, $page = null)
{
    $data['page'] = $page;
    return http_build_query($data);
}

if (! empty($_GET['keyword']) || ! empty($_GET['location']))
{
    $data = array(
        'publisher' => 1989,
        'channel' => 'Sample code',
        'user_ip' => $_SERVER['REMOTE_ADDR'],
        'user_agent' => $_SERVER['HTTP_USER_AGENT'],
        'keyword' => @$_GET['keyword'],
        'location' => @$_GET['location'],
        'page' => @$_GET['page'],
    );
    $api_url = "https://adview.online/api/v1/jobs.json?" . http_build_query($data);

    $result = json_decode(file_get_contents($api_url), true);

    $current_search = array(
        'keyword' => @$_GET['keyword'],
        'location' => @$_GET['location'],
    );

    $total = $result['total'];
    $current_page = $result['current_page'];
    list($low_index, $high_index) = getPaginationIndex($current_page, $result['last_page'], 7);
}
?>
<!doctype html>
<html lang="en">
<head>
    <title>FeedAPI - Search<?php echo empty($_GET['keyword']) ? " " : " {$_GET['keyword']} "; ?>jobs<?php echo empty($_GET['location']) ? "" : " in {$_GET['location']}"; ?></title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
    <style>
    .highlighted {
        font-weight: bold;
    }
    </style>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-65912969-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12 text-center">
                <a href="./" style="text-decoration: none;"><h1>Job search</h1></a>
                <form class="form-inline">
                    <div class="form-group">
                        <input name="keyword" value="<?php echo @$_GET['keyword']; ?>" class="form-control" placeholder="Enter your keyword">
                        <input name="location" value="<?php echo @$_GET['location']; ?>" class="form-control" placeholder="Enter your location">
                        <input type="submit" value="Search" class="btn btn-default">
                    </div>
                </form>
                <h6><a href="feed-api.php">How did I build this website?</a></h6>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-10 col-sm-push-1">
                <?php if (! empty($result)): ?>
                    <h4>Total result: <?php echo number_format($total); ?></h4>
                    <table class="table table-condensed">
                    <?php foreach ($result['data'] as $job): ?>
                        <tr>
                            <td>
                                <div class="col-sm-6 h2">
                                    <a href="<?php echo $job['url']; ?>" onmousedown="<?php echo $job['onmousedown']; ?>" target="_NEW" rel="nofollow"><?php echo $job['title']; ?></a>
                                </div>
                                <br>
                                <?php if (! empty($job['salary'])): ?>
                                <div class="col-sm-6 text-right" style="color: #888;"><strong><?php echo $job['salary']; ?></strong></div>
                                <?php endif; ?>
                                <?php if (! empty($job['location'])): ?>
                                <div class="col-sm-6 text-right" style="color: #888;">Location: <strong><?php echo $job['location']; ?></strong></div>
                                <?php endif; ?>
                                <div class="col-sm-10"><?php echo $job['snippet']; ?></div>
                                <div class="col-sm-2">
                                    <?php if (! empty($job['logo'])): ?>
                                    <a href="?<?php echo generateURL(array('keyword' => $job['company'])); ?>"><img align="right" src="<?php echo $job['logo']; ?>"></a>
                                    <?php endif; ?>
                                </div>
                                <div class="col-sm-12" style="color: #999;">
                                    <?php if (! empty($job['company'])): ?>
                                    Company: <strong><?php echo $job['company']; ?></strong>
                                    <?php endif; ?>
                                    <?php if (! empty($job['job_type'])): ?>
                                    Job type: <strong><?php echo $job['job_type']; ?></strong>
                                    <?php endif; ?>
                                    (<span><?php echo $job['age']; ?></span>)
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    </table>
                    <a target="_NEW" href="https://adview.online" title="Job Search">jobs</a> by <a target="_blank" title="Job Search" href="https://adview.online"><img alt="AdView job search" style="border: 0; vertical-align: middle;" src="https://adview.online/job-search.png"></a>
                    <script type="text/javascript" src="https://adview.online/js/pub/tracking.js?publisher=6&channel=Sample%20code&source=feed"></script>
                    <hr class="col-xs-12">
                    <div class="col-sm-12 text-center">
                        <ul class="pagination">
                        <?php for ($page = $low_index; $page <= $high_index; $page++): ?>
                            <?php if ($page == $current_page): ?>
                            <li class="active"><a><?php echo $page; ?></a></li>
                            <?php else: ?>
                            <li><a href="?<?php echo generateURL($current_search, $page); ?>"><?php echo $page; ?></a></li>
                            <?php endif; ?>
                        <?php endfor; ?>
                        </ul>
                    </div>
                <?php else: ?>
                    <hr class="col-xs-12">
                    <?php foreach (getLocations() as $location): ?>
                        <div class="col-xs-12 col-sm-6 col-md-3">
                            <a href="?<?php echo generateURL(array('location' => $location)); ?>">Jobs in <?php echo $location; ?></a>
                        </div>
                    <?php endforeach; ?>
                    <hr class="col-xs-12">
                    <?php foreach (getCategories() as $category): ?>
                        <div class="col-xs-12 col-sm-6 col-md-3">
                            <a href="?<?php echo generateURL(array('keyword' => $category)); ?>"><?php echo $category; ?> jobs</a>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
                <span class="clearfix"></span>
                <hr class="col-xs-12">
                <div class="text-center h6">&copy;2017 l3ehnam</div>
            </div>
        </div>
    </div>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</body>
</html>

